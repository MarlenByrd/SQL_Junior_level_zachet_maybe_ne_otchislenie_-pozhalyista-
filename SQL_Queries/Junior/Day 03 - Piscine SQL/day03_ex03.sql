WITH gender_visits AS (SELECT piz.name AS pizzeria_name, per.gender FROM person_visits pv JOIN person per ON pv.person_id = per.id JOIN pizzeria piz ON pv.pizzeria_id = piz.id), male_visits AS (SELECT pizzeria_name FROM gender_visits WHERE gender = 'male'), female_visits AS (SELECT pizzeria_name FROM gender_visits WHERE gender = 'female') SELECT pizzeria_name FROM (SELECT pizzeria_name FROM male_visits EXCEPT ALL SELECT pizzeria_name FROM female_visits) AS diff UNION ALL SELECT pizzeria_name FROM (SELECT pizzeria_name FROM female_visits EXCEPT ALL SELECT pizzeria_name FROM male_visits) AS diff2 ORDER BY pizzeria_name;
